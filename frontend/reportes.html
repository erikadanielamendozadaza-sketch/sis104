<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProLimp - Reportes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/estilos.css">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="background-color: #f8f9fa;">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-home"></i> ProLimp</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="inventario.html"><i class="fas fa-box"></i> Inventario</a>
                <a class="nav-link" href="ventas.html"><i class="fas fa-shopping-cart"></i> Ventas</a>
                <a class="nav-link" href="clientes.html"><i class="fas fa-users"></i> Clientes</a>
                <a class="nav-link active" href="reportes.html"><i class="fas fa-chart-bar"></i> Reportes</a>
                <a class="nav-link" href="usuarios.html"><i class="fas fa-user-cog"></i> Usuarios</a>
                <a class="nav-link" href="index.html"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="text-center mb-4"><i class="fas fa-chart-bar"></i> Reportes y Estadísticas</h1>

        <!-- Cards de resumen -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-success shadow">
                    <div class="card-body">
                        <h6>Ventas Totales</h6>
                        <h3>$<span id="ventasTotales">0</span></h3>
                        <small>Todos los tiempos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info shadow">
                    <div class="card-body">
                        <h6>Pedidos Totales</h6>
                        <h3 id="pedidosTotales">0</h3>
                        <small>Cantidad de pedidos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning shadow">
                    <div class="card-body">
                        <h6>Productos en Stock</h6>
                        <h3 id="productosStock">0</h3>
                        <small>Total productos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-primary shadow">
                    <div class="card-body">
                        <h6>Clientes Activos</h6>
                        <h3 id="clientesActivos">0</h3>
                        <small>Total clientes</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
            <!-- Gráfico de Ventas por Mes -->
            <div class="col-md-6">
                <div class="card shadow p-3">
                    <h5><i class="fas fa-chart-line"></i> Ventas por Mes</h5>
                    <canvas id="chartVentas"></canvas>
                </div>
            </div>

            <!-- Gráfico de Productos Más Vendidos -->
            <div class="col-md-6">
                <div class="card shadow p-3">
                    <h5><i class="fas fa-chart-pie"></i> Productos Más Vendidos</h5>
                    <canvas id="chartProductos"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabla de Últimos Pedidos -->
        <div class="card shadow p-3 mt-4">
            <h5><i class="fas fa-list"></i> Últimos 10 Pedidos</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tablaUltimosPedidos"></tbody>
                </table>
            </div>
        </div>

        <!-- Productos con Stock Bajo -->
        <div class="card shadow p-3 mt-4">
            <h5><i class="fas fa-exclamation-triangle"></i> Productos con Stock Bajo</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Stock Actual</th>
                            <th>Stock Mínimo</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tablaStockBajo"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chartVentas = null;
        let chartProductos = null;

        async function cargarReportes() {
            try {
                // Cargar datos
                const [pedidosResp, productosResp, clientesResp] = await Promise.all([
                    fetch('http://localhost:3000/pedidos'),
                    fetch('http://localhost:3000/productos'),
                    fetch('http://localhost:3000/clientes')
                ]);

                const pedidos = await pedidosResp.json();
                const productos = await productosResp.json();
                const clientes = await clientesResp.json();

                // Calcular totales
                const ventasTotales = pedidos.reduce((sum, p) => sum + parseFloat(p.total || 0), 0);
                document.getElementById('ventasTotales').textContent = ventasTotales.toFixed(2);
                document.getElementById('pedidosTotales').textContent = pedidos.length;
                document.getElementById('productosStock').textContent = productos.length;
                document.getElementById('clientesActivos').textContent = clientes.length;

                // Últimos 10 pedidos
                const ultimos10 = pedidos.slice(0, 10);
                const tbodyPedidos = document.getElementById('tablaUltimosPedidos');
                tbodyPedidos.innerHTML = '';
                ultimos10.forEach(pedido => {
                    const cliente = clientes.find(c => c.id == pedido.id_cliente);
                    const nombreCliente = cliente ? `${cliente.nombre} ${cliente.primerApellido}` : 'Cliente #' + pedido.id_cliente;
                    tbodyPedidos.innerHTML += `
                        <tr>
                            <td>#${pedido.id}</td>
                            <td>${nombreCliente}</td>
                            <td>${pedido.fecha || 'No especificada'}</td>
                            <td>$${pedido.total || 0}</td>
                            <td><span class="badge bg-${pedido.estado === 'entregado' ? 'success' : 'warning'}">${pedido.estado || 'pendiente'}</span></td>
                        </tr>
                    `;
                });

                // Productos con stock bajo
                const stockBajo = productos.filter(p => p.stock_actual < p.stock_minimo);
                const tbodyStock = document.getElementById('tablaStockBajo');
                tbodyStock.innerHTML = '';
                stockBajo.forEach(producto => {
                    tbodyStock.innerHTML += `
                        <tr>
                            <td>${producto.nombre}</td>
                            <td>${producto.stock_actual}</td>
                            <td>${producto.stock_minimo}</td>
                            <td><span class="badge bg-danger">Reabastecer</span></td>
                        </tr>
                    `;
                });

                // Preparar datos para gráficos
                await cargarGraficos(pedidos, productos);

            } catch (error) {
                console.error('Error cargando reportes:', error);
            }
        }

        async function cargarGraficos(pedidos, productos) {
            // Datos simulados si no hay pedidos
            if (pedidos.length === 0) {
                // Gráfico de ventas con datos de ejemplo
                const ctxVentas = document.getElementById('chartVentas').getContext('2d');
                chartVentas = new Chart(ctxVentas, {
                    type: 'line',
                    data: {
                        labels: ['Enero', 'Febrero', 'Marzo', 'Abril'],
                        datasets: [{
                            label: 'Ventas ($)',
                            data: [1200, 1900, 3000, 2500],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });

                // Gráfico de productos con datos de ejemplo
                const ctxProductos = document.getElementById('chartProductos').getContext('2d');
                chartProductos = new Chart(ctxProductos, {
                    type: 'doughnut',
                    data: {
                        labels: productos.slice(0, 5).map(p => p.nombre),
                        datasets: [{
                            label: 'Stock',
                            data: productos.slice(0, 5).map(p => p.stock_actual),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'right' }
                        }
                    }
                });
            } else {
                // Gráfico de Ventas por Mes (con datos reales)
                const ventasPorMes = {};
                pedidos.forEach(pedido => {
                    if (pedido.fecha) {
                        const fecha = new Date(pedido.fecha);
                        const mes = fecha.toLocaleDateString('es', { month: 'short', year: 'numeric' });
                        ventasPorMes[mes] = (ventasPorMes[mes] || 0) + parseFloat(pedido.total || 0);
                    }
                });

                const ctxVentas = document.getElementById('chartVentas').getContext('2d');
                if (chartVentas) chartVentas.destroy();
                chartVentas = new Chart(ctxVentas, {
                    type: 'line',
                    data: {
                        labels: Object.keys(ventasPorMes).length > 0 ? Object.keys(ventasPorMes) : ['Sin datos'],
                        datasets: [{
                            label: 'Ventas ($)',
                            data: Object.keys(ventasPorMes).length > 0 ? Object.values(ventasPorMes) : [0],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });

                // Gráfico de productos más vendidos
                const ctxProductos = document.getElementById('chartProductos').getContext('2d');
                chartProductos = new Chart(ctxProductos, {
                    type: 'doughnut',
                    data: {
                        labels: productos.slice(0, 5).map(p => p.nombre),
                        datasets: [{
                            label: 'Stock Actual',
                            data: productos.slice(0, 5).map(p => p.stock_actual),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'right' }
                        }
                    }
                });
            }
        }

        // Cargar al iniciar
        cargarReportes();
    </script>
</body>
</html>