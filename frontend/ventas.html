<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProLimp - Ventas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/estilos.css" />
  </head>
  <body style="background-color: #f8f9fa">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
      <div class="container">
        <a class="navbar-brand" href="dashboard.html"
          ><i class="fas fa-home"></i> ProLimp</a
        >
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="inventario.html"
            ><i class="fas fa-box"></i> Inventario</a
          >
          <a class="nav-link active" href="ventas.html"
            ><i class="fas fa-shopping-cart"></i> Ventas</a
          >
          <a class="nav-link" href="clientes.html"
            ><i class="fas fa-users"></i> Clientes</a
          >
          <a class="nav-link" href="reportes.html"
            ><i class="fas fa-chart-bar"></i> Reportes</a
          >
          <a class="nav-link" href="usuarios.html"><i class="fas fa-user-cog"></i> Usuarios</a>
          <a class="nav-link" href="index.html"
            ><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a
          >
        </div>
      </div>
    </nav>

    <div class="container mt-5">
      <h1 class="text-center mb-4">
        <i class="fas fa-shopping-cart"></i> Registro de Ventas/Pedidos
      </h1>

      <div class="row">
        <!-- Formulario de pedido -->
        <div class="col-md-7">
          <div class="card shadow p-4">
            <h5><i class="fas fa-file-invoice"></i> Nuevo Pedido</h5>
            <form id="formPedido">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label>Cliente</label>
                  <select class="form-control" id="clienteSelect" required>
                    <option value="">Seleccionar Cliente</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label>Fecha</label>
                  <input
                    type="date"
                    class="form-control"
                    id="fechaPedido"
                    required
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-12">
                  <label>Ubicación de Entrega</label>
                  <input
                    type="text"
                    class="form-control"
                    id="ubicacionPedido"
                    placeholder="Dirección de entrega"
                  />
                </div>
              </div>
              <hr />
              <h6><i class="fas fa-box"></i> Agregar Productos</h6>
              <div class="row">
                <div class="col-md-6">
                  <label>Producto</label>
                  <select class="form-control" id="productoSelect">
                    <option value="">Seleccionar Producto</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label>Cantidad</label>
                  <input
                    type="number"
                    class="form-control"
                    id="cantidadPedido"
                    min="1"
                    value="1"
                  />
                </div>
                <div class="col-md-3">
                  <label>&nbsp;</label><br />
                  <button
                    type="button"
                    class="btn btn-secondary w-100"
                    onclick="agregarAlCarrito()"
                  >
                    <i class="fas fa-plus"></i> Agregar
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Carrito -->
        <div class="col-md-5">
          <div class="card shadow p-4">
            <h5><i class="fas fa-shopping-basket"></i> Carrito de Compra</h5>
            <div id="carrito">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cant.</th>
                    <th>Precio</th>
                    <th>Subtotal</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="listaCarrito"></tbody>
              </table>
              <hr />
              <h4 class="text-end">
                Total: $<span id="totalPedido">0.00</span>
              </h4>
              <button
                type="button"
                class="btn btn-success w-100"
                onclick="registrarPedido()"
              >
                <i class="fas fa-check"></i> Registrar Pedido
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Cierra el row principal -->

      <!-- Tabla de pedidos realizados -->
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow p-4">
            <h5><i class="fas fa-history"></i> Pedidos Realizados</h5>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Ubicación</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaPedidos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Cierra el container -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let carrito = [];
      let productos = [];
      let clientes = [];

      async function cargarDatos() {
        try {
          // Cargar productos
          const prodResp = await fetch("http://localhost:3000/productos");
          productos = await prodResp.json();
          const prodSelect = document.getElementById("productoSelect");
          prodSelect.innerHTML =
            '<option value="">Seleccionar Producto</option>';
          productos.forEach((p) => {
            prodSelect.innerHTML += `<option value="${p.id}">${p.nombre} - Stock: ${p.stock_actual}</option>`;
          });

          // Cargar clientes
          const cliResp = await fetch("http://localhost:3000/clientes");
          clientes = await cliResp.json();
          const cliSelect = document.getElementById("clienteSelect");
          cliSelect.innerHTML = '<option value="">Seleccionar Cliente</option>';
          clientes.forEach((c) => {
            cliSelect.innerHTML += `<option value="${c.id}">${c.nombre} ${c.primerApellido}</option>`;
          });

          // Fecha por defecto: hoy
          document.getElementById("fechaPedido").valueAsDate = new Date();
        } catch (error) {
          console.error("Error cargando datos:", error);
          alert("Error cargando datos. Verifica el servidor.");
        }
      }

      function agregarAlCarrito() {
        const prodId = document.getElementById("productoSelect").value;
        const cant = parseInt(document.getElementById("cantidadPedido").value);

        if (!prodId) {
          alert("Selecciona un producto");
          return;
        }

        const prod = productos.find((p) => p.id == prodId);
        if (!prod) return;

        if (cant > prod.stock_actual) {
          alert(`Stock insuficiente. Disponible: ${prod.stock_actual}`);
          return;
        }

        // Verificar si ya está en carrito
        const itemExistente = carrito.find(
          (item) => item.producto.id == prodId
        );
        if (itemExistente) {
          if (itemExistente.cantidad + cant > prod.stock_actual) {
            alert("No hay suficiente stock para agregar más");
            return;
          }
          itemExistente.cantidad += cant;
          itemExistente.subtotal = itemExistente.cantidad * prod.precio;
        } else {
          carrito.push({
            producto: prod,
            cantidad: cant,
            subtotal: prod.precio * cant,
          });
        }

        actualizarCarrito();
        // Limpiar selección
        document.getElementById("productoSelect").value = "";
        document.getElementById("cantidadPedido").value = 1;
      }

      function actualizarCarrito() {
        const tbody = document.getElementById("listaCarrito");
        tbody.innerHTML = "";
        let total = 0;

        carrito.forEach((item, index) => {
          tbody.innerHTML += `
                    <tr>
                        <td>${item.producto.nombre}</td>
                        <td>${item.cantidad}</td>
                        <td>$${item.producto.precio}</td>
                        <td>$${item.subtotal.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="quitarDelCarrito(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
          total += item.subtotal;
        });

        document.getElementById("totalPedido").textContent = total.toFixed(2);
      }

      function quitarDelCarrito(index) {
        carrito.splice(index, 1);
        actualizarCarrito();
      }

      async function registrarPedido() {
        const clienteId = document.getElementById("clienteSelect").value;
        const fecha = document.getElementById("fechaPedido").value;
        const ubicacion = document.getElementById("ubicacionPedido").value;

        if (!clienteId) {
          alert("Selecciona un cliente");
          return;
        }

        if (carrito.length === 0) {
          alert("Agrega productos al carrito");
          return;
        }

        try {
          // Registrar pedido
          const pedResp = await fetch("http://localhost:3000/pedidos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id_cliente: clienteId,
              fecha,
              ubicacion_entrega: ubicacion,
              total: parseFloat(
                document.getElementById("totalPedido").textContent
              ),
            }),
          });

          if (!pedResp.ok) throw new Error("Error registrando pedido");

          const pedido = await pedResp.json();
          const pedidoId = pedido.id;

          // Registrar detalles y actualizar stock
          for (const item of carrito) {
            // Registrar detalle
            await fetch("http://localhost:3000/detalles_pedidos", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id_pedido: pedidoId,
                id_producto: item.producto.id,
                cantidad: item.cantidad,
                subtotal: item.subtotal,
              }),
            });

            // Actualizar stock
            const nuevoStock = item.producto.stock_actual - item.cantidad;
            await fetch(`http://localhost:3000/productos/${item.producto.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ stock_actual: nuevoStock }),
            });
          }

          alert(`¡Pedido #${pedidoId} registrado exitosamente!`);

          // Limpiar todo
          carrito = [];
          actualizarCarrito();
          document.getElementById("formPedido").reset();
          document.getElementById("fechaPedido").valueAsDate = new Date();

          // Recargar datos para actualizar stock y pedidos
          await cargarDatos();
          await cargarPedidos(); // Actualizar tabla de pedidos
        } catch (error) {
          console.error("Error registrando pedido:", error);
          alert("Error al registrar el pedido");
        }
      }

      async function cargarPedidos() {
        try {
          const response = await fetch("http://localhost:3000/pedidos");
          const pedidos = await response.json();
          const tbody = document.getElementById("tablaPedidos");
          tbody.innerHTML = "";

          for (const pedido of pedidos) {
            // Buscar nombre del cliente
            const cliente = clientes.find((c) => c.id == pedido.id_cliente);
            const nombreCliente = cliente
              ? `${cliente.nombre} ${cliente.primerApellido}`
              : "Cliente #" + pedido.id_cliente;

            // Determinar color del badge según estado
            let colorBadge = "warning";
            if (pedido.estado === "entregado") colorBadge = "success";
            else if (pedido.estado === "cancelado") colorBadge = "danger";

            tbody.innerHTML += `
                <tr>
                    <td>#${pedido.id}</td>
                    <td>${nombreCliente}</td>
                    <td>${pedido.fecha}</td>
                    <td>${pedido.ubicacion_entrega || "No especificada"}</td>
                    <td>$${pedido.total}</td>
                    <td>
                        <span class="badge bg-${colorBadge}">
                            ${pedido.estado || "pendiente"}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="verDetallePedido(${
                          pedido.id
                        })">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="cambiarEstadoPedido(${
                          pedido.id
                        }, '${pedido.estado || "pendiente"}')">
                            <i class="fas fa-edit"></i> Estado
                        </button>
                    </td>
                </tr>
            `;
          }
        } catch (error) {
          console.error("Error cargando pedidos:", error);
        }
      }

      async function verDetallePedido(pedidoId) {
        try {
          const response = await fetch(
            `http://localhost:3000/pedidos/${pedidoId}/detalles`
          );
          const detalles = await response.json();

          let mensaje = `Detalle del Pedido #${pedidoId}:\n\n`;
          detalles.forEach((d) => {
            mensaje += `- ${d.nombre_producto}: ${d.cantidad} unidades x $${d.precio} = $${d.subtotal}\n`;
          });

          alert(mensaje);
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function cambiarEstadoPedido(pedidoId, estadoActual) {
        // Mostrar modal con opciones
        const modalHtml = `
                <div class="modal fade" id="modalEstado" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Cambiar Estado del Pedido #${pedidoId}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Estado actual: <strong>${estadoActual}</strong></p>
                                <label>Nuevo estado:</label>
                                <select class="form-control" id="nuevoEstado">
                                    <option value="pendiente" ${
                                      estadoActual === "pendiente"
                                        ? "selected"
                                        : ""
                                    }>Pendiente</option>
                                    <option value="entregado" ${
                                      estadoActual === "entregado"
                                        ? "selected"
                                        : ""
                                    }>Entregado</option>
                                    <option value="cancelado" ${
                                      estadoActual === "cancelado"
                                        ? "selected"
                                        : ""
                                    }>Cancelado</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="guardarEstado(${pedidoId})">Guardar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        // Remover modal anterior si existe
        const modalExistente = document.getElementById("modalEstado");
        if (modalExistente) {
          modalExistente.remove();
        }

        // Agregar modal al body
        document.body.insertAdjacentHTML("beforeend", modalHtml);

        // Mostrar modal
        const modal = new bootstrap.Modal(
          document.getElementById("modalEstado")
        );
        modal.show();
      }

      // Función para guardar el nuevo estado
      async function guardarEstado(pedidoId) {
        const nuevoEstado = document.getElementById("nuevoEstado").value;

        try {
          const response = await fetch(
            `http://localhost:3000/pedidos/${pedidoId}/estado`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ estado: nuevoEstado }),
            }
          );

          if (response.ok) {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("modalEstado")
            );
            modal.hide();

            // Mostrar mensaje de éxito
            alert(`Estado actualizado a: ${nuevoEstado}`);

            // Recargar tabla
            await cargarPedidos();
          } else {
            alert("Error al actualizar estado");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al conectar con el servidor");
        }
      }

      // Inicializar - Solo una vez
      cargarDatos().then(() => cargarPedidos());
    </script>
  </body>
</html>
